generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  CUSTOMER
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  CREATOR
}

enum EventStatus {
  PUBLISHED
  CANCELLED
}

enum CreditPackage {
  SMALL
  MEDIUM
  LARGE
}

enum OtpPurpose {
  FORGOT_PASSWORD
  RESET_PASSWORD
}

enum NotificationType {
  EVENT_CREATED
  EVENT_UPDATED
  EVENT_REMINDER
  EVENT_CANCELLED
  ORG_APPROVED
  PAYMENT_SUCCESS
  ORGANIZATION_DELETED
  EVENT_DELETED
  USER_DELETED
}

enum NotificationEntity {
  EVENT
  ORGANIZATION
  USER
  PAYMENT
}

enum OrganizationType {
  INDIVIDUAL
  COMPANY
  EDUCATIONAL
  COMMUNITY
  NON_PROFIT
  GOVERNMENT
}

enum EventType {
  WORKSHOP
  MEETUP
  CONFERENCE
  WEBINAR
  HACKATHON
  COMPETITION
  OTHER
}

enum AdminAction {
  CREATE
  UPDATE
  DELETE
}

enum AdminEntityType {
  EVENT
  ORGANIZATION
  USER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  password  String?
  role      Role     @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  image     String?

  //relation of the user table to the other table 
  session            Session[]
  organizationMember OrganizationMember[]
  createdEvents      Event[]
  creditPurchases    CreditPurchase[]
  eventParticipants  EventParticipants[]
  notifications      Notification[]
  otpdetails         Otpdetails[]
  eventMessages      EventMessage[]
  adminLogs          AdminLogs[]
}

model Otpdetails {
  id        String     @id @default(uuid())
  userId    String
  otp       String     @unique
  purpose   OtpPurpose
  expiresAt DateTime
  used      Boolean    @default(false)
  createdAt DateTime   @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

//session table to store user loggedin details and past sessions of an use r
model Session {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @unique
  refreshToken String   @unique
  expiresOn    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accessToken])
  @@index([refreshToken])
}

// organization table 
model Organization {
  id              String               @id @default(cuid())
  name            String
  thumbnail       String?
  image           String?
  website         String?
  description     String
  type            OrganizationType     @default(INDIVIDUAL)
  credits         Int                  @default(20)
  lastCreditReset DateTime             @default(now())
  isPremium       Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  members         OrganizationMember[]
  events          Event[]
  creditPurchases CreditPurchase[]

  @@index([name])
}

model OrganizationMember {
  id             String           @id @default(cuid())
  userId         String
  organizationId String
  role           OrganizationRole @default(MEMBER)
  joinedAt       DateTime         @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
}

model Event {
  id             String @id @default(cuid())
  slug           String @unique
  organizationId String
  creatorId      String

  title       String
  description String
  location    String

  startDate DateTime
  endDate   DateTime

  capacity        Int
  registeredCount Int @default(1)

  status EventStatus @default(PUBLISHED)

  // recommendation metadata
  category EventType @default(OTHER)
  tags     String[]
  image    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  organization  Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator       User                @relation(fields: [creatorId], references: [id])
  participants  EventParticipants[]
  eventMessages EventMessage[]

  @@index([organizationId])
  @@index([creatorId])
  @@index([startDate])
  @@index([status])
  @@index([category])
  @@index([status, startDate])
  @@index([organizationId, status])
}

model EventParticipants {
  id           String   @id @default(cuid())
  eventId      String
  userId       String
  registeredAt DateTime @default(now())
  checkInToken String   @unique

  //for check in 
  attended    Boolean   @default(false)
  checkedInAt DateTime?

  //relations 
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([attended])
}

model CreditPurchase {
  id             String        @id @default(cuid())
  organizationId String
  purchasedBy    String
  package        CreditPackage
  credits        Int
  amount         Float

  purchasedAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [purchasedBy], references: [id])

  @@index([organizationId])
  @@index([purchasedBy])
}

model Notification {
  id     String @id @default(cuid())
  userId String

  title   String
  message String

  type       NotificationType
  entityType NotificationEntity
  entityId   String?

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model EventMessage {
  id        String   @id @default(cuid())
  eventId   String
  senderId  String
  message   String
  createdAt DateTime @default(now())

  event  Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sender User  @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([senderId])
  @@index([createdAt])
}

model AdminLogs {
  id         String          @id @default(cuid())
  adminId    String
  action     AdminAction
  entityId   String
  entityType AdminEntityType
  createdAt  DateTime        @default(now())
  reason     String

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([createdAt])
}

model ErrorLog {
  id      String @id @default(cuid())
  code    Int
  message String
  status  String
}
